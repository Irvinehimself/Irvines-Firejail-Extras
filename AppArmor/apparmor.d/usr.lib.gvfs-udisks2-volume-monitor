# Last Modified: Thu Jun  7 02:04:30 2018
@{EXTDOCS1}=/home/*/Docs/
@{EXTDOCS2}=/home/*/Shared/
@{EXTDOCS3}=/home/*/Usbs/

#include <tunables/home>

# vim:syntax=apparmor

# AppArmor policy for gvfs-udisks2-volume-monitor
# Author: irvine mcminn at gmail dot com
# GPL3


/usr/lib/gvfs-udisks2-volume-monitor {
  #include <abstractions/freedesktop.org>
  #include <local/usr.lib.gvfs-udisks2-volume-monitor>

  deny signal receive set=cont peer=unconfined,
  deny signal receive set=term peer=unconfined,
  deny signal receive set=kill peer=unconfined,

  signal receive set=term peer=/usr/lib/gvfs-udisks2-volume-monitor,
  signal send set=term peer=/usr/lib/gvfs-udisks2-volume-monitor,

  deny /proc/*/net/netlink r,
  deny /proc/*/net/packet r,
  deny /proc/*/net/raw r,

  # ### This just matches comparable entry in the 'usr.lib.udisks2.udisksd' profile
  # ### That entry disables mounting usbs and external drives through udisks2 and/or
  # ### the file manager. As a result, all mounts are handled by 'Hs-MountReadWrite'
  # ### For reasoning, see:
  # ### https://github.com/Irvinehimself/TheBeggarsHardeningProject/tree/master/HsTool
  # ### deny /run/media/
  deny owner /run/media/** rmxwlk,
  deny owner /run/media/ rmxwlk,
  deny owner /media/** rmxwlk,
  deny owner /media/ rmxwlk,
  deny /run/media/** rmxwlk,
  deny /run/media/ rmxwlk,
  deny /media/** rmxwlk,
  deny /media/ rmxwlk,

  # ### deny @{EXTDOCS1}
  deny owner @{EXTDOCS1}** mxwlk,
  deny owner @{EXTDOCS2}** mxwlk,
  deny owner @{EXTDOCS3}** mxwlk,
  deny @{EXTDOCS1}** mxwlk,
  deny @{EXTDOCS2}** mxwlk,
  deny @{EXTDOCS3}** mxwlk,

  # ### allow  @{EXTDOCS1}
  owner @{EXTDOCS1}** r,
  owner @{EXTDOCS2}** r,
  owner @{EXTDOCS3}** r,
  @{EXTDOCS1}** r,
  @{EXTDOCS2}** r,
  @{EXTDOCS3}** r,

  # ### allow /home/
  owner /home/*/.local/share/mime/treemagic r,


  # ### allow /proc/
  owner /proc/*/fd/ r,
  owner /proc/*/fdinfo/* r,
  owner /proc/*/mountinfo r,
  owner /proc/*/mounts r,

  # ### allow /run/systemd/
  owner /run/systemd/sessions/1 r,

  # ### allow /
  / r,

  # ### allow /dev/
  /dev/null rw,

  # ### allow /etc/
  /etc/fstab r,
  /etc/ld.so.cache r,
  /etc/ld.so.preload r,
  /etc/nsswitch.conf r,
  /etc/passwd r,

  # ### allow /proc/
  /proc/ r,
  /proc/*/cgroup r,
  /proc/*/maps r,
  /proc/*/net/unix r,
  /proc/*/stat r,
  /proc/filesystems r,
  /proc/locks r,

  # ### allow /run/mount/
  /run/mount/utab r,

  # ### allow /run/udev/
  /run/udev/data/b8:* r,

  # ### allow /sys/devices/
  /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?.?/?-?.?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/uevent r,
  /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?.?/?-?.?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/uevent r,
  /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/uevent r,
  /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/uevent r,
  /sys/devices/pci0000:00/0000:00:??.?/ata?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/uevent r,

  # ### allow /usr/bin/
  /usr/bin/lsof mrix,

  # ### allow /usr/lib/gconv/
  /usr/lib/gconv/gconv-modules r,

  # ### allow /usr/lib/gio/
  /usr/lib/gio/modules/ r,
  /usr/lib/gio/modules/giomodule.cache r,
  /usr/lib/gio/modules/libgiognomeproxy.so mr,
  /usr/lib/gio/modules/libgiognutls.so mr,
  /usr/lib/gio/modules/libgiolibproxy.so mr,
  /usr/lib/gio/modules/libgvfsdbus.so mr,

  # ### allow /usr/lib/gvfs/
  /usr/lib/gvfs/libgvfscommon.so mr,

  # ### allow /usr/lib/local/
  /usr/lib/locale/locale-archive r,

  # ### allow /usr/lib/
  /usr/lib/ld-*.so mr,
  /usr/lib/libblkid.so.* mr,
  /usr/lib/libbluray.so.* mr,
  /usr/lib/libbz2.so.* mr,
  /usr/lib/libc-*.so mr,
  /usr/lib/libdl-*.so mr,
  /usr/lib/libexpat.so.* mr,
  /usr/lib/libffi.so.* mr,
  /usr/lib/libfontconfig.so.* mr,
  /usr/lib/libfreetype.so.* mr,
  /usr/lib/libgcc_s.so.* mr,
  /usr/lib/libgcrypt.so.* mr,
  /usr/lib/libgio-2.0.so.* mr,
  /usr/lib/libglib-2.0.so.* mr,
  /usr/lib/libgmodule-2.0.so.* mr,
  /usr/lib/libgmp.so.* mr,
  /usr/lib/libgnutls.so.* mr,
  /usr/lib/libgobject-2.0.so.* mr,
  /usr/lib/libgpg-error.so.* mr,
  /usr/lib/libgraphite2.so.* mr,
  /usr/lib/libgudev-1.0.so.* mr,
  /usr/lib/libharfbuzz.so.* mr,
  /usr/lib/libhogweed.so.* mr,
  /usr/lib/libicudata.so.* r,
  /usr/lib/libicuuc.so.* mr,
  /usr/lib/liblz4.so.* mr,
  /usr/lib/liblzma.so.* mr,
  /usr/lib/libm-*.so mr,
  /usr/lib/libmount.so.* mr,
  /usr/lib/libnettle.so.* mr,
  /usr/lib/libnss_files-*.so mr,
  /usr/lib/libp11-kit.so.* mr,
  /usr/lib/libpcre.so.* mr,
  /usr/lib/libpng16.so.* mr,
  /usr/lib/libproxy.so.* mr,
  /usr/lib/libpthread-*.so mr,
  /usr/lib/libresolv-*.so mr,
  /usr/lib/librt-*.so mr,
  /usr/lib/libsecret-1.so.* mr,
  /usr/lib/libselinux.so.* mr,
  /usr/lib/libstdc++.so.* mr,
  /usr/lib/libsystemd.so.* mr,
  /usr/lib/libtasn1.so.* mr,
  /usr/lib/libudev.so.* mr,
  /usr/lib/libudisks2.so.* mr,
  /usr/lib/libunistring.so.* mr,
  /usr/lib/libuuid.so.* mr,
  /usr/lib/libxml2.so.* mr,
  /usr/lib/libz.so.* mr,

  # ### allow /usr/usr.share/
  /usr/share/locale/*/LC_MESSAGES/glib20.mo r,
  /usr/share/locale/*/LC_MESSAGES/gvfs.mo r,
  /usr/share/locale/*/LC_MESSAGES/libc.mo r,
  /usr/share/locale/*/LC_MESSAGES/udisks2.mo r,
  /usr/share/locale/locale.alias r,

}
