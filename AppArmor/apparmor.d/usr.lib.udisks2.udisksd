# Last Modified: Fri May 25 17:31:46 2018
#include <tunables/kernelvars>

# vim:syntax=apparmor
# AppArmor policy for udisks2d
# Author: irvine mcminn at gmail dot com
# GPL3


/usr/lib/udisks2/udisksd {
  #include <abstractions/dri-enumerate>
  #include <local/usr.lib.udisks2.udisksd>

  # ### allow capabilities
  capability dac_override,
  capability dac_read_search,
  capability mknod,
  capability setgid,
  capability setuid,
  capability sys_admin,
  capability sys_rawio,

  # ### allow mount capabilities
  mount,
  remount,
  umount,

  # ### deny signal
  deny signal receive set=cont peer=unconfined,
  deny signal receive set=exists peer=unconfined,
  deny signal receive set=int peer=unconfined,
  deny signal receive set=kill peer=unconfined,
  deny signal receive set=term peer=unconfined,

  # ### allow signal
  signal receive set=term peer=/usr/lib/udisks2/udisksd,
  signal send set=term peer=/usr/lib/udisks2/udisksd,

  # ### This disables mounting usbs and external drives through udisks2 and/or
  # ### the file manager. As a result, all mounts are handled by 'Hs-MountReadWrite'
  # ### NOTE: there is a matching entry in '/etc/apparmor.d/'usr.lib.gvfs-udisks2-volume-monitor'
  # ### For reasoning, see:
  # ### https://github.com/Irvinehimself/TheBeggarsHardeningProject/tree/master/HsTools
  # ### deny owner /run/media/
  deny owner /run/media/** rmxwlk,
  deny owner /run/media/ rmxwlk,
  deny owner /media/** rmxwlk,
  deny owner /media/ rmxwlk,
  deny /run/media/** rmxwlk,
  deny /run/media/ rmxwlk,
  deny /media/** rmxwlk,
  deny /media/ rmxwlk,


  # ### allow /usr/bin/
  /usr/bin/dumpe2fs mrix,
  /usr/bin/eject mrix,
  /usr/bin/ntfs-3g mrix,
  /usr/bin/umount mrix,

  # ### allow owner /dev/
  owner /dev/fuse rw,
  owner /dev/null r,
  owner /dev/null w,
  owner /dev/sd? rwk,
  owner /dev/sd?? rwk,
  owner /dev/sr0 rw,

  # ### allow owner /etc/
  owner /etc/crypttab r,
  owner /etc/fstab r,
  owner /etc/group r,
  owner /etc/ld.so.cache r,
  owner /etc/ld.so.preload r,
  owner /etc/libblockdev/conf.d/ r,
  owner /etc/libblockdev/conf.d/00-default.cfg r,
  owner /etc/nsswitch.conf r,
  owner /etc/passwd r,
  owner /etc/udisks2/udisks2.conf r,

  # ### allow owner /proc/
  owner /proc/*/fd/ r,
  owner /proc/*/mountinfo r,
  owner /proc/*/mounts r,
  owner /proc/filesystems r,
  owner /proc/swaps r,


  # ### allow owner /run/mount/
  owner /run/mount/utab rw,
  owner /run/mount/utab.* rw,
  owner /run/mount/utab.lock rwk,

  # ### allow owner /run/systemd/
  owner /run/systemd/seats/seat[0-9] r,

  # ### allow owner /run/udev/
  owner /run/udev/data/b{[0-9],[1-9][0-9]}:{[0-9],[1-9][0-9]} r,

  # ### allow owner /run/udisks2/
  owner /run/udisks2/ w,
  owner /run/udisks2/mounted-fs w,
  owner /run/udisks2/mounted-fs.* rw,

  # ### allow owner /sys/bus/
  owner /sys/bus/ r,

  # ### allow owner /sys/class/
  owner /sys/class/ r,
  owner /sys/class/block/ r,

  # ### allow owner /sys/devices/
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?.?/?-?.?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/ r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?.?/?-?.?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/queue/rotational r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?.?/?-?.?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/removable r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?.?/?-?.?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/ro r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?.?/?-?.?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/partition r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?.?/?-?.?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/ro r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?.?/?-?.?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/size r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?.?/?-?.?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/start r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?.?/?-?.?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/size r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?.?/remove w,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/ r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/queue/rotational r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/removable r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/ro r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/partition r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/ro r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/size r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/start r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/size r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/?-?.?:?.?/remove w,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?.?/remove w,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/ r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/queue/rotational r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/removable r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/ro r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/partition r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/ro r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/size r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/sd??/start r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sd?/size r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sr0/ r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sr0/queue/rotational r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sr0/removable r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sr0/ro r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/?-?:?.?/host?/target?:?:?/?:?:?:?/block/sr0/size r,
  owner /sys/devices/pci0000:00/0000:00:??.?/usb?/?-?/remove w,
  owner /sys/devices/pci0000:00/0000:00:??.?/ata?/host?/target?:?:?/?:?:?:?/block/sda/queue/rotational r,
  owner /sys/devices/pci0000:00/0000:00:??.?/ata?/host?/target?:?:?/?:?:?:?/block/sda/removable r,
  owner /sys/devices/pci0000:00/0000:00:??.?/ata?/host?/target?:?:?/?:?:?:?/block/sda/ro r,
  owner /sys/devices/pci0000:00/0000:00:??.?/ata?/host?/target?:?:?/?:?:?:?/block/sda/sda?/ro r,
  owner /sys/devices/pci0000:00/0000:00:??.?/ata?/host?/target?:?:?/?:?:?:?/block/sda/sda?/size r,
  owner /sys/devices/pci0000:00/0000:00:??.?/ata?/host?/target?:?:?/?:?:?:?/block/sda/size r,
  owner /sys/devices/pci0000:00/0000:00:??.?/ata?/host?/target?:?:?/?:?:?:?/block/sda/stat r,

  # ### allow owner /usr/lib/gconv/
  owner /usr/lib/gconv/gconv-modules r,

  # ### allow owner /usr/lib/gio/
  owner /usr/lib/gio/modules/ r,
  owner /usr/lib/gio/modules/giomodule.cache r,
  owner /usr/lib/gio/modules/libdconfsettings.so mr,
  owner /usr/lib/gio/modules/libgiognomeproxy.so mr,
  owner /usr/lib/gio/modules/libgiognutls.so mr,
  owner /usr/lib/gio/modules/libgiolibproxy.so mr,
  owner /usr/lib/gio/modules/libgioremote-volume-monitor.so mr,
  owner /usr/lib/gio/modules/libgsettingsgconfbackend.so mr,
  owner /usr/lib/gio/modules/libgvfsdbus.so mr,

  # ### allow owner /usr/lib/gvfs/
  owner /usr/lib/gvfs/libgvfscommon.so mr,

  # ### allow owner /usr/lib/locale/
  owner /usr/lib/locale/** r,

  # ### allow owner /usr/lib/
  owner /usr/lib/libacl.so.* mr,
  owner /usr/lib/libargon2.so.* mr,
  owner /usr/lib/libassuan.so.* mr,
  owner /usr/lib/libatasmart.so.* mr,
  owner /usr/lib/libattr.so.* mr,
  owner /usr/lib/libbd_crypto.so.* mr,
  owner /usr/lib/libbd_fs.so.* mr,
  owner /usr/lib/libbd_loop.so.* mr,
  owner /usr/lib/libbd_mdraid.so.* mr,
  owner /usr/lib/libbd_part.so.* mr,
  owner /usr/lib/libbd_part_err.so.* mr,
  owner /usr/lib/libbd_swap.so.* mr,
  owner /usr/lib/libbd_utils.so.* mr,
  owner /usr/lib/libblkid.so.* mr,
  owner /usr/lib/libblockdev.so.* mr,
  owner /usr/lib/libbytesize.so.* mr,
  owner /usr/lib/libc-*.so mr,
  owner /usr/lib/libcom_err.so.* mr,
  owner /usr/lib/libcryptsetup.so.* mr,
  owner /usr/lib/libdbus-1.so.* mr,
  owner /usr/lib/libdbus-glib-1.so.* mr,
  owner /usr/lib/libdevmapper.so.* mr,
  owner /usr/lib/libdl-*.so mr,
  owner /usr/lib/libe2p.so.* mr,
  owner /usr/lib/libext2fs.so.* mr,
  owner /usr/lib/libffi.so.* mr,
  owner /usr/lib/libfuse.so.* mr,
  owner /usr/lib/libgcc_s.so.* mr,
  owner /usr/lib/libgconf-2.so.* mr,
  owner /usr/lib/libgcrypt.so.* mr,
  owner /usr/lib/libgio-2.0.so.* mr,
  owner /usr/lib/libglib-2.0.so.* mr,
  owner /usr/lib/libgmodule-2.0.so.* mr,
  owner /usr/lib/libgmp.so.* mr,
  owner /usr/lib/libgnutls.so.* mr,
  owner /usr/lib/libgobject-2.0.so.* mr,
  owner /usr/lib/libgpg-error.so.* mr,
  owner /usr/lib/libgpgme.so.* mr,
  owner /usr/lib/libgudev-1.0.so.* mr,
  owner /usr/lib/libhogweed.so.* mr,
  owner /usr/lib/libjson-c.so.* mr,
  owner /usr/lib/libkmod.so.* mr,
  owner /usr/lib/liblz4.so.* mr,
  owner /usr/lib/liblzma.so.* mr,
  owner /usr/lib/libm-*.so mr,
  owner /usr/lib/libmount.so.* mr,
  owner /usr/lib/libmpfr.so.* mr,
  owner /usr/lib/libnettle.so.* mr,
  owner /usr/lib/libnspr*.so mr,
  owner /usr/lib/libnss*.so mr,
  owner /usr/lib/libnss_files-*.so mr,
  owner /usr/lib/libntfs-3g.so.* mr,
  owner /usr/lib/libp11-kit.so.* mr,
  owner /usr/lib/libparted-fs-resize.so.* mr,
  owner /usr/lib/libparted.so.* mr,
  owner /usr/lib/libpcre.so.* mr,
  owner /usr/lib/libplc*.so mr,
  owner /usr/lib/libplds*.so mr,
  owner /usr/lib/libpolkit-gobject-1.so.* mr,
  owner /usr/lib/libproxy.so.* mr,
  owner /usr/lib/libpthread-*.so mr,
  owner /usr/lib/libresolv-*.so mr,
  owner /usr/lib/librt-*.so mr,
  owner /usr/lib/libselinux.so.* mr,
  owner /usr/lib/libsmime*.so mr,
  owner /usr/lib/libssl*.so mr,
  owner /usr/lib/libstdc++.so.* mr,
  owner /usr/lib/libsystemd.so.* mr,
  owner /usr/lib/libtasn1.so.* mr,
  owner /usr/lib/libudev.so.* mr,
  owner /usr/lib/libudisks2.so.* mr,
  owner /usr/lib/libunistring.so.* mr,
  owner /usr/lib/libuuid.so.* mr,
  owner /usr/lib/libvolume_key.so.* mr,
  owner /usr/lib/libz.so.* mr,

  # ### allow owner /usr/share/gvfs/
  owner /usr/share/gvfs/remote-volume-monitors/ r,
  owner /usr/share/gvfs/remote-volume-monitors/udisks2.monitor r,

  # ### allow owner /usr/share/locale/
  owner /usr/share/locale/*/LC_MESSAGES/libc.mo r,
  owner /usr/share/locale/locale.alias r,

  # ### allow owner /usr/share/
  owner /usr/share/zoneinfo/*/* r,

}
